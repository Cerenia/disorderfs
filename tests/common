trap "Unmount 2>/dev/null" EXIT

Mount () {
	#while getopts "m" opt; do
	#	case $opt in
	#		s) src=timed/;;
	#	esac
	#done

	Unmount
	mkdir -p target
	# remove -m from params before passing it on
	for arg do
  		shift
		if
  			[ "$arg" = "-m" ];
			then src=timed/ && continue;
		fi
  		set -- "$@" "$arg"
	done
	if [ -z "$src" ];
		then src=fixtures/;
	fi
	../disorderfs -q "${@}" "$src" target/
}

Unmount () {
	fusermount -q -z -u target/ && rm -rf target/
}

Get_entries () {
	find target -type f -printf %f
}

Fail () {
	echo "E: ${*}"
	exit 1
}

Expect () {
	ENTRIES="$(Get_entries)"
	EXPECTED="${1}"

	if [ "${ENTRIES}" != "${EXPECTED}" ]
	then
		Fail "saw ${ENTRIES}, expected ${EXPECTED}"
	fi
}
